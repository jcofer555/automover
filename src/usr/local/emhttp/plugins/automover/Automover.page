Menu="Utilities"
Type="xmenu"
Title="Automover"
Icon="zip.png"
Tag="zip.png"
Markdown="false"
---
<?php
$config_path = "/boot/config/plugins/automover/settings.cfg";
$trigger_log_path = "/boot/config/plugins/automover/last_triggered.log";
$go_path = "/boot/config/go";

// Handle form submission
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
  $config = [
    'POOL_NAME'    => $_POST['POOL_NAME'],
    'THRESHOLD'    => $_POST['THRESHOLD'],
    'DRY_RUN'      => $_POST['DRY_RUN'] ?? 'no',
    'LOOP_INTERVAL'=> $_POST['LOOP_INTERVAL'],
    'AUTOSTART'    => $_POST['AUTOSTART'] ?? 'no',
  ];
  file_put_contents($config_path, implode("\n", array_map(fn($k) => "$k={$config[$k]}", array_keys($config))));

  $start_cmd = "nohup /usr/bin/automover_monitor.sh >/dev/null 2>&1 &";
  $go_contents = file_exists($go_path) ? file_get_contents($go_path) : '';

  if ($config['AUTOSTART'] === 'yes' && strpos($go_contents, $start_cmd) === false) {
    file_put_contents($go_path, trim($go_contents) . "\n$start_cmd\n");
  } elseif ($config['AUTOSTART'] === 'no' && strpos($go_contents, $start_cmd) !== false) {
    file_put_contents($go_path, str_replace($start_cmd, '', $go_contents));
  }

  header("Location: " . $_SERVER['REQUEST_URI'] . "?saved=1");
  exit;
}

// Load config
$config = file_exists($config_path) ? parse_ini_file($config_path) : [];
$pool       = $config['POOL_NAME'] ?? 'cache';
$threshold  = $config['THRESHOLD'] ?? 90;
$dry_run    = $config['DRY_RUN'] ?? 'no';
$interval   = $config['LOOP_INTERVAL'] ?? 300;
$autostart  = $config['AUTOSTART'] ?? 'no';
$last_run   = file_exists($trigger_log_path) ? trim(file_get_contents($trigger_log_path)) : 'â€”';

// Get usage
$usage = 0;
$mount = "/mnt/{$pool}";
if (is_dir($mount)) {
  $raw = shell_exec("df -h --si \"$mount\" | awk 'NR==2 {print \$5}' | sed 's/%//'");
  $usage = is_numeric(trim($raw)) ? intval(trim($raw)) : 0;
}

// Parse pools
$pools = [];
$ini = parse_ini_file("/var/local/emhttp/disks.ini", true);
foreach ($ini as $d => $info) {
  $label = strtolower($info['name'] ?? '');
  if (in_array($label, ['parity', 'parity2', 'flash'])) continue;
  if (strpos($label, 'disk') === 0) continue;
  $pools[] = $label;
}

// Monitor status
$pidfile = "/var/run/automover_monitor.pid";
$status = "ğŸ”´ <span style='color:red;'>Stopped</span>";
if (file_exists($pidfile)) {
  $pid = trim(file_get_contents($pidfile));
  if (ctype_digit($pid) && posix_kill((int)$pid, 0)) {
    $status = "ğŸŸ¢ <span style='color:green;'>Running</span>";
  }
}

// Action buttons
if (isset($_GET['action'])) {
  $cmd = match ($_GET['action']) {
    'start' => "nohup /usr/bin/automover_monitor.sh >/dev/null 2>&1 &",
    'stop'  => "pkill -f automover_monitor.sh",
    'restart' => "pkill -f automover_monitor.sh && nohup /usr/bin/automover_monitor.sh >/dev/null 2>&1 &",
    default => ''
  };
  if ($cmd) exec($cmd);
  header("Location: " . $_SERVER['REQUEST_URI']);
  exit;
}
?>

<h2>ğŸ› ï¸ Automover Plugin Settings</h2>
  <p><strong>ğŸ§  Monitor Status:</strong> <?= $status ?></p>

  <?php if (isset($_GET['saved'])): ?>
    <div style="color:green;">âœ… Settings saved successfully.</div>
  <?php endif ?>

  <form method="POST">
    <div class="form-row">
      <label><strong>ğŸ“ Select Pool:</strong></label><br>
      <select name="POOL_NAME">
        <?php foreach ($pools as $opt): ?>
          <option value="<?= $opt ?>" <?= $opt === $pool ? 'selected' : '' ?>><?= ucfirst($opt) ?></option>
        <?php endforeach ?>
      </select>
    </div>

    <div class="form-row">
      <label><strong>ğŸ“Š Threshold (%):</strong></label><br>
      <input type="number" name="THRESHOLD" value="<?= $threshold ?>" min="1" max="100">
    </div>

    <div class="form-row">
      <label><strong>ğŸ§ª Dry Run Mode:</strong></label><br>
      <select name="DRY_RUN">
        <option value="yes" <?= $dry_run === 'yes' ? 'selected' : '' ?>>Yes</option>
        <option value="no" <?= $dry_run === 'no' ? 'selected' : '' ?>>No</option>
      </select>
    </div>

    <div class="form-row">
      <label><strong>â±ï¸ Check Interval (seconds):</strong></label><br>
      <input type="number" name="LOOP_INTERVAL" value="<?= $interval ?>" min="10">
    </div>

    <div class="form-row">
      <label><input type="checkbox" name="AUTOSTART" value="yes" <?= $autostart === 'yes' ? 'checked' : '' ?>>
        Enable auto-start on system boot</label>
    </div>

    <input type="submit" value="ğŸ’¾ Save Settings">
  </form>

  <hr>
  <h3>ğŸ“ˆ Usage for <code><?= ucfirst($pool) ?></code></h3>
  <?php
    $color = ($usage < $threshold - 10) ? 'low' : (($usage <= $threshold) ? 'mid' : 'high');
  ?>
  <div class="usage-bar">
    <div class="usage-fill <?= $color ?>" style="width:<?= $usage ?>%">
      <?= $usage ?>%
    </div>
  </div>
  <p style="margin-top:6px;">ğŸ•’ Last Triggered: <strong><?= $last_run ?></strong></p>

  <h3>ğŸš€ Script Control</h3>
  <form method="GET">
    <button name="action" value="start">â–¶ï¸ Start</button>
    <button name="action" value="stop">â¹ï¸ Stop</button>
    <button name="action" value="restart">ğŸ”„ Restart</button>
  </form>
